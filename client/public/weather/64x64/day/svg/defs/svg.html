<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

	<style type="text/css">
		svg {
			margin: 0 auto;
			display: block;
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%)
		}
	
		.cloud {
			fill: none;
			stroke: #3996D2;
			stroke-width: 1px;
		}
	
		.sun {
			fill: none;
			stroke: #F1C413;
		}
	
		.mask {
			fill: black;
			stroke: black;
			stroke-width: 5px;
		}
	</style>
</head>
<body>
<!-- 
<mask id="small-cloud-mask">
	<rect x="0" y="0" width="64" height="64" fill="white" />
	<use href="#cloud-big" class="cloud mask" width="44" height="28" x="4" y="-3" />
	<use href="#sun" class="sun mask" width="29" height="29" x="3" y="-8" />
</mask>
 -->
	<svg id="svg" width="256" height="256" version="1.1" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
		<defs id="defs">
			<symbol id="cloud-big" viewBox="0 0 43 27.73">
				<path vector-effect="non-scaling-stroke"
					d=" M 37.678 13.447 C 40.495 14.468 42.511 17.065 42.5 20.101 C 42.5 24.044 39.158 27.233 35.034 27.233 L 7.031 27.233 C 3.422 27.233 0.5 24.445 0.5 20.999 C 0.5 17.848 2.944 15.261 6.124 14.831 C 6.334 10.821 9.79 7.632 14.039 7.632 C 14.459 7.632 14.86 7.67 15.261 7.728 C 16.922 3.508 21.171 0.5 26.174 0.5 C 32.618 0.5 37.841 5.493 37.841 11.642 C 37.841 12.263 37.783 12.855 37.678 13.447 L 37.678 13.447 Z " />
			</symbol>
		
			<symbol id="cloud-small" viewBox="0 0 43 27.73">
				<path vector-effect="non-scaling-stroke"
					d="M5.3,13.4c-0.1-0.6-0.2-1.2-0.2-1.8c0-6.1,5.2-11.1,11.7-11.1 c5,0,9.3,3,10.9,7.2c0.4-0.1,0.8-0.1,1.2-0.1c4.2,0,7.7,3.2,7.9,7.2c3.2,0.4,5.6,3,5.6,6.2c0,3.4-2.9,6.2-6.5,6.2H8 c-4.1,0-7.5-3.2-7.5-7.1C0.5,17.1,2.5,14.5,5.3,13.4L5.3,13.4z" />
			</symbol>
		
			<symbol id="sun" viewBox="0 0 36 36">
				<g transform-origin="center center" id="sunUse">
					<animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="30s"
						repeatCount="indefinite" />
		
					<circle vector-effect="non-scaling-stroke" stroke-linecap="round" id="sun_orb" cx="18" cy="18" r="9" />
					<g transform-origin="center">
						<g transform-origin="center" transform="rotate(0)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="0s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(30)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="-1s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(60)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="0s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(90)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="-1s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(120)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="0s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(150)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="-1s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(180)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="0s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(210)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="-1s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(240)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="0s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(270)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="-1s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(300)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="0s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
						<g transform-origin="center" transform="rotate(330)">
							<line vector-effect="non-scaling-stroke" transform="translate(30 18)" stroke-linecap="round" x1="0"
								y1="0" x2="5" y2="0">
								<animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; .2 1; 1 1"
									begin="-1s" dur="2s" repeatCount="indefinite" />
							</line>
						</g>
					</g>
				</g>
			</symbol>
		



			<rect id="whiteRect" x="0" y="0" width="64" height="64" fill="white" />

		</defs>


		<!-- <rect width="64" height="64" fill="#fafafa" /> -->


		<mask id="sun-mask">
			<rect x="0" y="0" width="64" height="64" fill="white" />
			<!-- position of use in mask is position of <use> as object minus position of the item you want to mask -->
			<use href="#cloud-big" class="cloud mask" width="44" height="28" x="1" y="5" />
		</mask>
		
		<use id="use_sun" width="29" height="29" x="11" y="12" href="#sun" class="sun" data-id="sun" data-masks="['cloud-big']" mask="url(#sun-mask)" />
		<use id="use_cloud-big" width="44" height="28" x="12" y="17" href="#cloud-big" class="cloud" />

	</svg>
</body>

<script>
	// utils
	const useIdPrefix = 'use_'
	const getUseId = (id) => `${useIdPrefix}${id}`

	const _diff = (a, b) => {
		const r = {};
		Object.keys(a).forEach(key => {
			r[key] = a[key] - b[key]
		})
		return r;
	}

	const processParam = (p) => {
		let arr;
		try {
			arr = eval(p)
		} catch {
			arr = [];
		}
		return arr;
	}

	const defs = document.getElementById('defs');

	const svg = document.getElementById('svg');

	const viewBox = (p) => {
		try {
			const arr = p.split(' ').map(item => eval(item));
			return {
				x: arr[0],
				y: arr[1],
				width: arr[2],
				height: arr[3]
			}
		} catch {
			return {}
		}
	}

	const svgProps = {
		width: eval(svg.getAttribute('width')),
		height: eval(svg.getAttribute('height')),
		viewBox: viewBox(svg.getAttribute('viewBox'))
	}

	const initMask = (maskId) => {
		const maskTag = document.createElement('mask');
		maskTag.setAttribute('id', `mask_${maskId}`)
		// const whiteRect = document.createElement('rect');
		// whiteRect.setAttribute('fill', 'white')

		// Object.entries(svgProps.viewBox).forEach(([key, value]) => {
		// 	whiteRect.setAttribute(key, value);
		// });
		const whiteRect = document.getElementById('whiteRect').cloneNode();
		maskTag.appendChild(whiteRect);
		
		return maskTag
	}


</script>

<script>

		(() => {
			const itemsWithMasks = document.querySelectorAll('[data-masks]')
			itemsWithMasks.forEach(item => {
				// get masks elements list from attribute

				// yes, I know eval() is dangerous

				const maskId = item.dataset.id;
				const maskElements = item.dataset.masks;
				const pos = {
					x: parseFloat(item.getAttribute('x')),
					y: parseFloat(item.getAttribute('y'))
				}
				const masks = processParam(maskElements);
				console.log({item,  masks})

				const maskTag = initMask(maskId);


				masks.forEach((mask, index) => {

					/* get use element that will be used in mask */
					const useId = getUseId(mask)

					const use = document.getElementById(useId)
					const maskPos = {
						x: parseFloat(use.getAttribute('x')),
						y: parseFloat(use.getAttribute('y'))
					}
					console.log({ mask, index, use })
					const useMask = use.cloneNode()
					useMask.classList.add('mask')

					const diff = _diff(maskPos, pos)

					useMask.setAttribute('x', diff.x)
					useMask.setAttribute('y', diff.y)

					console.log('diff', diff)

					maskTag.appendChild(useMask)

				})
				defs.appendChild(maskTag)
				item.setAttribute('mask', 'url(#mask_sun)')

				console.log(document.getElementById('sun-mask'))
				console.log(maskTag)

			})
		})();

</script>
</html>